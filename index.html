<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sigma Data Model Manager (Standalone)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-hover: #222230;
            --border: #2a2a3a;
            --border-focus: #5865f2;
            --text-primary: #f0f0f5;
            --text-secondary: #9090a0;
            --text-muted: #606070;
            --accent: #5865f2;
            --accent-hover: #6875f3;
            --success: #43b581;
            --warning: #faa61a;
            --error: #f04747;
            --json-key: #79c0ff;
            --json-string: #a5d6ff;
            --json-number: #d2a8ff;
            --json-boolean: #ff7b72;
            --json-null: #8b949e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: visible;
        }
        
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            transition: transform 0.1s ease;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .logo-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 48px;
        }
        
        /* Credentials Section */
        .credentials-section {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            overflow: visible;
            position: relative;
        }
        
        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 16px;
        }
        
        .form-group {
            margin-bottom: 14px;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        
        input, select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            transition: all 0.15s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(88, 101, 242, 0.15);
        }
        
        input::placeholder {
            color: var(--text-muted);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            filter: brightness(1.1);
        }
        
        .btn-ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .btn-ai:hover {
            filter: brightness(1.1);
        }
        
        .btn-ai:disabled {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        /* AI Assistant Styles */
        .ai-prompt {
            resize: vertical;
            min-height: 80px;
        }
        
        .ai-explanation {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            font-size: 13px;
            line-height: 1.5;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .ai-config {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .ai-config .form-group {
            margin-bottom: 12px;
        }
        
        .ai-config .form-group:last-child {
            margin-bottom: 0;
        }
        
        .ai-mode-tabs {
            display: flex;
            gap: 8px;
        }
        
        .ai-mode-tab {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .ai-mode-tab:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .ai-mode-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        .ai-mode-content {
            margin-top: 16px;
        }
        
        .ai-hint-box {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        /* Data Models List */
        .models-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .models-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .models-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .model-item {
            padding: 14px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 4px;
        }
        
        .model-item:hover {
            background: var(--bg-tertiary);
        }
        
        .model-item.active {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-focus);
        }
        
        .model-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .model-meta {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            gap: 12px;
        }
        
        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }
        
        .toolbar-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .toolbar-actions {
            display: flex;
            gap: 10px;
        }
        
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .editor-tabs {
            display: flex;
            gap: 2px;
            padding: 12px 24px 0;
            background: var(--bg-secondary);
        }
        
        .editor-tab {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .editor-tab.active {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border);
        }
        
        .json-editor {
            flex: 1;
            padding: 24px;
            overflow: auto;
            background: var(--bg-primary);
        }
        
        .json-editor textarea {
            width: 100%;
            height: 100%;
            min-height: calc(100vh - 200px);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.7;
            color: var(--text-primary);
            resize: none;
            tab-size: 2;
        }
        
        .json-editor textarea:focus {
            outline: none;
            border-color: var(--border-focus);
        }
        
        /* Status Messages */
        .status-bar {
            padding: 10px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        
        .status-indicator.connected {
            background: var(--success);
        }
        
        .status-indicator.error {
            background: var(--error);
        }
        
        .status-indicator.loading {
            background: var(--warning);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            padding: 14px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            font-size: 13px;
            animation: slideIn 0.2s ease;
            max-width: 400px;
        }
        
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast.warning { border-left: 3px solid var(--warning); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            padding: 40px;
            text-align: center;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        
        .empty-state p {
            font-size: 14px;
            max-width: 300px;
        }
        
        /* Loading spinner */
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Tooltips */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 50%;
            font-size: 11px;
            color: var(--text-muted);
            cursor: help;
            margin-left: 8px;
        }

        .tooltip-text {
            visibility: hidden;
            position: absolute;
            z-index: 1000;
            left: calc(100% + 12px);
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            width: 280px;
            font-size: 12px;
            line-height: 1.5;
            color: var(--text-secondary);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .tooltip-text::before {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: var(--border);
        }

        .tooltip-text::after {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-right-color: var(--bg-tertiary);
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge.beta {
            background: rgba(250, 166, 26, 0.15);
            color: var(--warning);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .table-config {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .table-config-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .table-config-title {
            font-size: 14px;
            font-weight: 600;
        }
        
        .table-config-remove {
            background: none;
            border: none;
            color: var(--error);
            font-size: 12px;
            cursor: pointer;
        }
        
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        
        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }
        
        select.form-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239090a0' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        select.form-input option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--border-focus);
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
        }
        
        .form-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }
        
        .column-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .column-tag {
            background: var(--bg-hover);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .column-tag-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            padding: 0;
        }
        
        .column-tag-remove:hover {
            color: var(--error);
        }
        
        .add-column-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .add-column-row input {
            flex: 1;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .location-type-btn {
            padding: 10px 16px;
            font-size: 13px;
            transition: all 0.15s ease;
        }
        
        .location-type-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .browse-result {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .browse-result:hover {
            background: var(--bg-hover);
        }
        
        .browse-result.selected {
            background: var(--accent);
        }
        
        .browse-result-name {
            font-weight: 500;
        }
        
        .browse-result-type {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .selected-tables {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .selected-table-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .selected-table-name {
            font-size: 13px;
        }
        
        .remove-selected-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
        }
        
        .remove-selected-btn:hover {
            color: var(--error);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon" id="logoIcon" style="cursor: pointer;" title="Click 5 times to enable developer mode">Œ£</div>
                    <span class="logo-text">Data Model Manager</span>
                </div>
                <div class="logo-subtitle">Direct Sigma Integration <span class="badge beta">Standalone</span><span class="badge" id="devModeBadge" style="display: none; margin-left: 8px; background: rgba(255, 123, 114, 0.15); color: #ff7b72;">DEV</span></div>
            </div>
            
            <div class="credentials-section">
                <div class="section-title">API Credentials</div>
                
                <div class="form-group">
                    <label>
                        API Base URL
                        <span class="tooltip-container">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                Find your organization's API base URL in:<br><br>
                                <strong>Administration ‚Üí Developer Access ‚Üí API base URL</strong><br><br>
                                Then select the matching region from the dropdown.
                            </span>
                        </span>
                    </label>
                    <select id="apiRegion" onchange="selectRegion()">
                        <optgroup label="GCP">
                            <option value="https://api.sigmacomputing.com">api.sigmacomputing.com (GCP US)</option>
                            <option value="https://api.sa.gcp.sigmacomputing.com">api.sa.gcp.sigmacomputing.com (GCP KSA)</option>
                        </optgroup>
                        <optgroup label="AWS">
                            <option value="https://aws-api.sigmacomputing.com">aws-api.sigmacomputing.com (AWS US West)</option>
                            <option value="https://api.us-a.aws.sigmacomputing.com">api.us-a.aws.sigmacomputing.com (AWS US East)</option>
                            <option value="https://api.ca.aws.sigmacomputing.com">api.ca.aws.sigmacomputing.com (AWS Canada)</option>
                            <option value="https://api.eu.aws.sigmacomputing.com">api.eu.aws.sigmacomputing.com (AWS Europe)</option>
                            <option value="https://api.au.aws.sigmacomputing.com">api.au.aws.sigmacomputing.com (AWS Australia/APAC)</option>
                            <option value="https://api.uk.aws.sigmacomputing.com">api.uk.aws.sigmacomputing.com (AWS UK)</option>
                        </optgroup>
                        <optgroup label="Azure">
                            <option value="https://api.us.azure.sigmacomputing.com">api.us.azure.sigmacomputing.com (Azure US)</option>
                            <option value="https://api.eu.azure.sigmacomputing.com">api.eu.azure.sigmacomputing.com (Azure Europe)</option>
                            <option value="https://api.ca.azure.sigmacomputing.com">api.ca.azure.sigmacomputing.com (Azure Canada)</option>
                            <option value="https://api.uk.azure.sigmacomputing.com">api.uk.azure.sigmacomputing.com (Azure UK)</option>
                        </optgroup>
                        <optgroup label="Staging Environments" id="stagingOptgroup" style="display: none;">
                            <option value="https://api.staging.sigmacomputing.io" class="staging-option" style="display: none;">api.staging.sigmacomputing.io (Staging GCP)</option>
                            <option value="https://api.staging.us.aws.sigmacomputing.io" class="staging-option" style="display: none;">api.staging.us.aws.sigmacomputing.io (Staging AWS US)</option>
                            <option value="https://api.staging.us.azure.sigmacomputing.io" class="staging-option" style="display: none;">api.staging.us.azure.sigmacomputing.io (Staging Azure US)</option>
                            <option value="https://api.staging.ca.aws.sigmacomputing.io" class="staging-option" style="display: none;">api.staging.ca.aws.sigmacomputing.io (Staging AWS Canada)</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="clientId">Client ID</label>
                    <input type="text" id="clientId" placeholder="Enter your Client ID">
                </div>
                
                <div class="form-group">
                    <label for="clientSecret">Client Secret</label>
                    <input type="password" id="clientSecret" placeholder="Enter your Client Secret">
                </div>
                
                <button class="btn btn-primary" id="connectBtn" onclick="connect()">
                    <span>Connect to Sigma</span>
                </button>
                
                <div style="margin-top: 12px; text-align: center;">
                    <button onclick="clearCredentials()" style="background: none; border: none; color: var(--text-muted); font-size: 11px; cursor: pointer; text-decoration: underline;">
                        Clear saved credentials
                    </button>
                </div>
            </div>
            
            <div class="models-section">
                <div class="models-header">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span class="section-title" style="margin: 0;">Data Models</span>
                        <span id="modelsCount" style="font-size: 11px; color: var(--text-muted);"></span>
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <button class="btn btn-secondary" onclick="newDataModel()" style="padding: 6px 12px; font-size: 12px;" id="newModelBtn" disabled>
                            + New
                        </button>
                        <button class="btn btn-secondary" onclick="refreshModels()" style="padding: 6px 12px; font-size: 12px;" id="refreshBtn" disabled>
                            ‚Üª Refresh
                        </button>
                    </div>
                </div>
                <div style="padding: 8px 12px; border-bottom: 1px solid var(--border);">
                    <input type="text" 
                           id="modelsSearch" 
                           placeholder="Search models..." 
                           oninput="filterModels(this.value)"
                           style="width: 100%; padding: 8px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px;">
                </div>
                <div class="models-list" id="modelsList">
                    <div class="empty-state" style="padding: 40px 20px;">
                        <div class="empty-state-icon">üìä</div>
                        <p>Connect to Sigma to view your data models</p>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="toolbar">
                <div class="toolbar-title" id="editorTitle">No Data Model Selected</div>
                <div class="toolbar-actions">
                    <button class="btn btn-ai" onclick="openAIAssistant()" id="aiBtn" disabled title="AI Assistant">
                        ü§ñ AI Assistant
                    </button>
                    <button class="btn btn-secondary" onclick="refreshFromSigma()" id="refreshSigmaBtn" disabled title="Refresh from Sigma API">
                        ‚Üª Refresh
                    </button>
                    <button class="btn btn-secondary" onclick="formatJson()" id="formatBtn" disabled>
                        Format JSON
                    </button>
                    <button class="btn btn-secondary" onclick="copyJson()" id="copyBtn" disabled>
                        Copy
                    </button>
                    <button class="btn btn-success" onclick="saveDataModel()" id="saveBtn" disabled>
                        Save to Sigma
                    </button>
                </div>
            </div>
            
            <div class="editor-container">
                <div class="editor-tabs">
                    <div class="editor-tab active">JSON Representation</div>
                </div>
                <div class="json-editor">
                    <textarea id="jsonEditor" placeholder="Select a data model from the sidebar to view and edit its JSON representation...

WORKFLOW:
1. Connect to Sigma (enter your API credentials)
2. Select a data model from the sidebar, or click '+ New' to create one
3. Edit the JSON here
4. Click 'Save to Sigma' to push changes directly

This is the standalone version - changes are saved directly to Sigma."></textarea>
                </div>
            </div>
            
            <div class="status-bar">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Not connected</span>
            </div>
        </main>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- New Data Model Modal -->
    <div class="modal-overlay" id="newModelModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Create New Data Model</div>
                <button class="modal-close" onclick="closeNewModelModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Data Model Name *</label>
                    <input type="text" class="form-input" id="newModelName" placeholder="e.g., Sales Analytics">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Location *</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <button type="button" class="btn btn-secondary location-type-btn active" id="locTypeWorkspace" onclick="selectLocationType('workspace')" style="flex: 1;">
                            Workspace
                        </button>
                        <button type="button" class="btn btn-secondary location-type-btn" id="locTypePersonal" onclick="selectLocationType('personal')" style="flex: 1;">
                            My Documents
                        </button>
                    </div>
                </div>
                
                <div class="form-group" id="workspaceGroup">
                    <label class="form-label">Workspace *</label>
                    <select class="form-input" id="newModelWorkspaceId">
                        <option value="">Select a workspace...</option>
                    </select>
                    <div class="form-hint">Select the workspace containing your target folder</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Folder *</label>
                    <select class="form-input" id="newModelFolderId" disabled>
                        <option value="">Select a workspace first...</option>
                    </select>
                    <div class="form-hint">Select the folder where the data model will be created</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Connection *</label>
                    <select class="form-input" id="newModelConnectionId">
                        <option value="">Loading connections...</option>
                    </select>
                    <div class="form-hint">Select the data warehouse connection for your tables</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Tables</span>
                        <button class="btn btn-secondary btn-small" onclick="addTableConfig()">+ Add Table</button>
                    </label>
                    <div id="tablesContainer"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeNewModelModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createDataModelFromWizard()">Create Data Model</button>
            </div>
        </div>
    </div>
    
    <!-- AI Assistant Modal -->
    <div class="modal-overlay" id="aiModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">ü§ñ AI Assistant</div>
                <button class="modal-close" onclick="closeAIModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- API Configuration -->
                <div class="ai-config" id="aiConfig">
                    <div class="form-group">
                        <label class="form-label">AI Provider</label>
                        <select class="form-input" id="aiProvider" onchange="onAIProviderChange()">
                            <option value="openai">OpenAI (GPT-4o)</option>
                            <option value="anthropic">Anthropic (Claude Sonnet 4)</option>
                            <option value="gemini">Google (Gemini 2.0 Flash)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="password" class="form-input" id="aiApiKey" placeholder="Enter your API key">
                            <button class="btn btn-secondary" onclick="saveAIKey()">Save</button>
                        </div>
                        <div class="form-hint">Your API key is stored locally in your browser</div>
                    </div>
                </div>
                
                <hr style="border: none; border-top: 1px solid var(--border); margin: 16px 0;">
                
                <!-- Mode Selector -->
                <div class="form-group">
                    <label class="form-label">What do you want to do?</label>
                    <div class="ai-mode-tabs">
                        <button class="ai-mode-tab active" data-mode="enhance" onclick="setAIMode('enhance')">
                            ‚úèÔ∏è Enhance Existing Model
                        </button>
                        <button class="ai-mode-tab" data-mode="addtable" onclick="setAIMode('addtable')">
                            ‚ûï Add New Table
                        </button>
                    </div>
                </div>
                
                <!-- Enhance Mode -->
                <div id="aiModeEnhance" class="ai-mode-content">
                    <div class="form-group">
                        <label class="form-label">What would you like to add or change?</label>
                        <textarea class="form-input ai-prompt" id="aiPromptEnhance" rows="3" placeholder="Examples:
‚Ä¢ Add a metric for Total Revenue that sums the Amount column
‚Ä¢ Create a calculated column for profit margin
‚Ä¢ Add a relationship between Orders and Customers on customer_id
‚Ä¢ Rename the Price column to Unit Price"></textarea>
                    </div>
                    <div class="ai-hint-box">
                        üí° The AI will use the columns and tables already in your data model.
                    </div>
                </div>
                
                <!-- Add Table Mode -->
                <div id="aiModeAddTable" class="ai-mode-content" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Connection</label>
                        <select class="form-input" id="aiConnection">
                            <option value="">Select a connection...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Table Path</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" class="form-input" id="aiDatabase" placeholder="DATABASE">
                            <input type="text" class="form-input" id="aiSchema" placeholder="SCHEMA">
                            <input type="text" class="form-input" id="aiTable" placeholder="TABLE">
                        </div>
                        <div class="form-hint">e.g., PLUGS_ELECTRONICS / PLUGS / D_PRODUCT</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            Column Definitions
                            <span class="form-hint" style="font-weight: normal; margin-left: 8px;">(paste from Sigma or your warehouse)</span>
                        </label>
                        <textarea class="form-input" id="aiColumns" rows="6" placeholder="Paste column names and types, one per line:

PRODUCT_KEY (number)
PRODUCT_NAME (text)
PRODUCT_TYPE (text)
PRICE (number)
CREATED_AT (datetime)

Or just column names:
PRODUCT_KEY
PRODUCT_NAME
..."></textarea>
                        <div class="form-hint">üí° Copy from Sigma's table browser, your warehouse's INFORMATION_SCHEMA, or describe what columns you need</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Additional Instructions (optional)</label>
                        <textarea class="form-input" id="aiPromptAddTable" rows="2" placeholder="e.g., Add a calculated column for full name, create a metric for total count..."></textarea>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="generateAISuggestion()" id="aiGenerateBtn" style="width: 100%; margin-top: 16px;">
                    ‚ú® Generate Suggestion
                </button>
                
                <!-- Results -->
                <div id="aiResults" style="display: none; margin-top: 16px;">
                    <div class="form-group">
                        <label class="form-label">üìù Generated JSON</label>
                        <textarea class="form-input" id="aiSuggestion" rows="10" style="font-family: monospace; font-size: 12px;"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üí¨ Explanation</label>
                        <div id="aiExplanation" class="ai-explanation"></div>
                    </div>
                    
                    <!-- Smart Insert Preview -->
                    <div id="aiPreview" class="form-group" style="display: none;">
                        <label class="form-label">üìç Insertion Preview</label>
                        <div style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-size: 12px;">
                            <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 8px;">
                                <span style="color: var(--success);">‚úì</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 4px;" id="aiPreviewType"></div>
                                    <div style="color: var(--text-secondary);" id="aiPreviewLocation"></div>
                                </div>
                            </div>
                            <div style="font-size: 11px; color: var(--text-muted); padding-left: 24px;" id="aiPreviewDetails"></div>
                        </div>
                    </div>
                    
                    <div class="ai-hint-box" style="margin-bottom: 12px;">
                        üí° <strong>Smart Insert</strong> will automatically find the right location and insert the JSON for you. Or <strong>Copy</strong> to paste manually.
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="smartInsertAISuggestion()" style="flex: 1;">
                            ‚ú® Smart Insert
                        </button>
                        <button class="btn btn-secondary" onclick="copyAISuggestion()" style="flex: 1;">
                            üìã Copy
                        </button>
                        <button class="btn btn-secondary" onclick="validateAISuggestion()" title="Check if the suggestion is valid">
                            ‚úì Validate
                        </button>
                        <button class="btn btn-secondary" onclick="generateAISuggestion()" title="Generate a new suggestion">
                            üîÑ
                        </button>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div id="aiLoading" style="display: none; text-align: center; padding: 20px;">
                    <div class="spinner" style="margin: 0 auto 12px;"></div>
                    <p>Generating suggestion...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // State
        let state = {
            baseUrl: 'https://api.sigmacomputing.com',
            accessToken: null,
            tokenExpiry: null,
            dataModels: [],
            filteredModels: [],
            selectedModel: null,
            originalJson: null,
            isNewModel: false
        };
        
        // Select API region
        function selectRegion() {
            const select = document.getElementById('apiRegion');
            state.baseUrl = select.value;
        }
        
        // Toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.2s ease reverse';
                setTimeout(() => toast.remove(), 200);
            }, 4000);
        }
        
        // Update status
        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = 'status-indicator ' + status;
            statusText.textContent = text;
        }
        
        // Connect to Sigma
        async function connect() {
            const clientId = document.getElementById('clientId').value.trim();
            const clientSecret = document.getElementById('clientSecret').value.trim();
            
            // Ensure base URL is set from the dropdown
            state.baseUrl = document.getElementById('apiRegion').value;
            
            if (!clientId || !clientSecret) {
                showToast('Please enter both Client ID and Client Secret', 'error');
                return;
            }
            
            const btn = document.getElementById('connectBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div><span>Connecting...</span>';
            updateStatus('loading', 'Authenticating...');
            
            try {
                // Get access token
                const tokenResponse = await fetch(`${state.baseUrl}/v2/auth/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'client_credentials',
                        client_id: clientId,
                        client_secret: clientSecret
                    })
                });
                
                if (!tokenResponse.ok) {
                    const error = await tokenResponse.json();
                    throw new Error(error.message || 'Authentication failed');
                }
                
                const tokenData = await tokenResponse.json();
                state.accessToken = tokenData.access_token;
                state.tokenExpiry = Date.now() + (tokenData.expires_in * 1000);
                
                // Save credentials to localStorage
                localStorage.setItem('sigma_standalone_credentials', JSON.stringify({
                    clientId,
                    clientSecret,
                    apiUrl: state.baseUrl
                }));
                
                updateStatus('connected', 'Connected to Sigma');
                showToast('Successfully connected to Sigma!', 'success');
                
                // Enable buttons
                document.getElementById('refreshBtn').disabled = false;
                document.getElementById('newModelBtn').disabled = false;
                
                // Load data models
                await loadDataModels();
                
            } catch (error) {
                console.error('Connection error:', error);
                updateStatus('error', 'Connection failed');
                showToast(`Connection failed: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Connect to Sigma</span>';
            }
        }
        
        // Load data models
        async function loadDataModels() {
            updateStatus('loading', 'Loading data models...');
            
            try {
                let allModels = [];
                let page = null;
                let hasMore = true;
                const limit = 50;
                
                // Paginate through all results
                while (hasMore) {
                    const url = new URL(`${state.baseUrl}/v2/datamodels`);
                    url.searchParams.set('limit', limit.toString());
                    if (page) {
                        url.searchParams.set('page', page);
                    }
                    
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${state.accessToken}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to load data models');
                    }
                    
                    const data = await response.json();
                    const entries = data.entries || [];
                    allModels = allModels.concat(entries);
                    
                    // Check if more pages exist
                    hasMore = data.hasMore === true && data.nextPage;
                    page = data.nextPage;
                    
                    // Update progress
                    if (data.total) {
                        updateStatus('loading', `Loading data models... (${allModels.length}/${data.total})`);
                    }
                    
                    // Safety break
                    if (!entries.length) break;
                }
                
                // Sort alphabetically by name
                allModels.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                
                state.dataModels = allModels;
                state.filteredModels = allModels;
                
                renderModelsList();
                updateStatus('connected', `Connected ‚Ä¢ ${state.dataModels.length} data models`);
                
            } catch (error) {
                console.error('Load error:', error);
                updateStatus('error', 'Failed to load data models');
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        // Filter models by search query
        function filterModels(query) {
            const searchTerm = query.toLowerCase().trim();
            if (!searchTerm) {
                state.filteredModels = state.dataModels;
            } else {
                state.filteredModels = state.dataModels.filter(model => 
                    (model.name || '').toLowerCase().includes(searchTerm)
                );
            }
            renderModelsList();
        }
        
        // Refresh models
        async function refreshModels() {
            if (!state.accessToken) return;
            // Clear search
            const searchInput = document.getElementById('modelsSearch');
            if (searchInput) searchInput.value = '';
            await loadDataModels();
            showToast('Data models refreshed', 'success');
        }
        
        // Render models list
        function renderModelsList() {
            const container = document.getElementById('modelsList');
            const models = state.filteredModels || state.dataModels || [];
            const totalCount = state.dataModels?.length || 0;
            const filteredCount = models.length;
            
            // Update count display
            const countDisplay = document.getElementById('modelsCount');
            if (countDisplay) {
                if (filteredCount !== totalCount) {
                    countDisplay.textContent = `(${filteredCount}/${totalCount})`;
                } else {
                    countDisplay.textContent = `(${totalCount})`;
                }
            }
            
            if (models.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 40px 20px;">
                        <div class="empty-state-icon">${totalCount > 0 ? 'üîç' : 'üì≠'}</div>
                        <p>${totalCount > 0 ? 'No matching data models' : 'No data models found in your organization'}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = models.map(model => `
                <div class="model-item ${state.selectedModel?.dataModelId === model.dataModelId ? 'active' : ''}" 
                     onclick="selectModel('${model.dataModelId}')">
                    <div class="model-name">${escapeHtml(model.name || 'Untitled')}</div>
                    <div class="model-meta">
                        <span>Updated: ${formatDate(model.updatedAt)}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }
        
        // Select a model
        async function selectModel(dataModelId) {
            updateStatus('loading', 'Loading data model...');
            
            try {
                // Fetch the JSON representation using v3alpha/spec endpoint
                const response = await fetch(`${state.baseUrl}/v3alpha/dataModels/${dataModelId}/spec`, {
                    headers: {
                        'Authorization': `Bearer ${state.accessToken}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to load data model');
                }
                
                const data = await response.json();
                // Ensure dataModelId is preserved (spec may not include it)
                state.selectedModel = { ...data, dataModelId: dataModelId };
                state.originalJson = JSON.stringify(data, null, 2);
                state.isNewModel = false; // This is an existing model
                
                // Update UI
                document.getElementById('jsonEditor').value = state.originalJson;
                document.getElementById('editorTitle').textContent = data.name || 'Untitled Data Model';
                
                // Enable buttons
                document.getElementById('formatBtn').disabled = false;
                document.getElementById('copyBtn').disabled = false;
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('refreshSigmaBtn').disabled = false;
                document.getElementById('aiBtn').disabled = false;
                
                renderModelsList();
                updateStatus('connected', `Editing: ${data.name || 'Untitled'}`);
                showToast('Data model loaded successfully', 'success');
                
            } catch (error) {
                console.error('Select error:', error);
                updateStatus('error', 'Failed to load data model');
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        // Format JSON
        function formatJson() {
            const editor = document.getElementById('jsonEditor');
            try {
                const parsed = JSON.parse(editor.value);
                editor.value = JSON.stringify(parsed, null, 2);
                showToast('JSON formatted', 'success');
            } catch (error) {
                showToast('Invalid JSON - cannot format', 'error');
            }
        }
        
        // Copy JSON
        function copyJson() {
            const editor = document.getElementById('jsonEditor');
            navigator.clipboard.writeText(editor.value);
            showToast('JSON copied to clipboard', 'success');
        }
        
        // Refresh from Sigma (reload current model)
        async function refreshFromSigma() {
            if (!state.accessToken || !state.selectedModel?.dataModelId) {
                showToast('No data model selected', 'error');
                return;
            }
            
            const dataModelId = state.selectedModel.dataModelId;
            const btn = document.getElementById('refreshSigmaBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 14px; height: 14px;"></div>';
            
            try {
                const response = await fetch(`${state.baseUrl}/v3alpha/dataModels/${dataModelId}/spec`, {
                    headers: { 'Authorization': `Bearer ${state.accessToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to fetch from Sigma');
                
                const spec = await response.json();
                // Preserve the dataModelId (spec may not include it)
                state.selectedModel = { ...spec, dataModelId: dataModelId };
                state.originalJson = JSON.stringify(spec, null, 2);
                document.getElementById('jsonEditor').value = state.originalJson;
                document.getElementById('editorTitle').textContent = spec.name || 'Untitled Data Model';
                
                showToast('Refreshed from Sigma', 'success');
                
            } catch (error) {
                console.error('Refresh error:', error);
                showToast(`Failed to refresh: ${error.message}`, 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = '‚Üª Refresh';
        }
        
        // Save data model
        async function saveDataModel() {
            const editor = document.getElementById('jsonEditor');
            let jsonData;
            
            try {
                jsonData = JSON.parse(editor.value);
            } catch (error) {
                showToast('Invalid JSON - please fix errors before saving', 'error');
                return;
            }
            
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div><span>Saving...</span>';
            
            // Check if this is a new model or existing
            const isNew = state.isNewModel === true;
            
            if (!isNew && !state.selectedModel?.dataModelId) {
                showToast('No data model selected', 'error');
                btn.disabled = false;
                btn.innerHTML = 'Save to Sigma';
                return;
            }
            
            updateStatus('loading', isNew ? 'Creating data model...' : 'Saving changes...');
            
            try {
                // Strip out metadata - only send spec fields that Sigma API expects
                const spec = {
                    schemaVersion: jsonData.schemaVersion || 1,
                    name: jsonData.name,
                    pages: jsonData.pages
                };
                
                // Include optional fields if present
                if (jsonData.description) spec.description = jsonData.description;
                if (jsonData.folderId) spec.folderId = jsonData.folderId;
                
                let response;
                
                if (isNew) {
                    // POST to create new data model
                    response = await fetch(`${state.baseUrl}/v3alpha/dataModels/spec`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(spec)
                    });
                } else {
                    // PUT to update existing data model - try with /spec
                    const dataModelId = state.selectedModel.dataModelId;
                    response = await fetch(`${state.baseUrl}/v3alpha/dataModels/${dataModelId}/spec`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${state.accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(spec)
                    });
                }
                
                if (!response.ok) {
                    // Try to get error message from response
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.text();
                        if (errorData) {
                            const errorJson = JSON.parse(errorData);
                            errorMessage = errorJson.message || errorMessage;
                        }
                    } catch (e) {
                        // If can't parse error, use status text
                    }
                    throw new Error(errorMessage);
                }
                
                // Handle response - might be empty for some endpoints
                let result = {};
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const text = await response.text();
                    if (text) {
                        result = JSON.parse(text);
                    }
                }
                
                // Get the dataModelId from result or state
                const dataModelId = result.dataModelId || state.selectedModel?.dataModelId;
                
                // Fetch the full spec back from Sigma to ensure we have complete data
                const refreshResponse = await fetch(`${state.baseUrl}/v3alpha/dataModels/${dataModelId}/spec`, {
                    headers: { 'Authorization': `Bearer ${state.accessToken}` }
                });
                
                if (!refreshResponse.ok) {
                    throw new Error('Saved but failed to refresh data');
                }
                
                const fullSpec = await refreshResponse.json();
                
                // Update state with the full spec from Sigma
                state.selectedModel = { ...fullSpec, dataModelId: dataModelId };
                state.originalJson = JSON.stringify(fullSpec, null, 2);
                state.isNewModel = false; // No longer new after saving
                editor.value = state.originalJson;
                
                // Update the title bar with new name
                document.getElementById('editorTitle').textContent = fullSpec.name || jsonData.name || 'Untitled Data Model';
                
                // Enable refresh button now that model exists
                document.getElementById('refreshSigmaBtn').disabled = false;
                
                updateStatus('connected', isNew ? 'Data model created!' : 'Changes saved');
                showToast(isNew ? 'Data model created in Sigma!' : 'Data model saved to Sigma!', 'success');
                
                // Refresh the list to get updated data
                await loadDataModels();
                
            } catch (error) {
                console.error('Save error:', error);
                updateStatus('error', 'Failed to save');
                showToast(`Save failed: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Save to Sigma';
            }
        }
        
        // Handle keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                e.preventDefault();
                if (!document.getElementById('saveBtn').disabled) {
                    saveDataModel();
                }
            }
        });
        
        // ============================================
        // NEW DATA MODEL WIZARD
        // ============================================
        
        let wizardState = {
            tables: [],
            connections: [],
            workspaces: [],
            folders: [],
            locationType: 'workspace' // 'workspace' or 'personal'
        };
        
        function selectLocationType(type) {
            wizardState.locationType = type;
            
            // Update button states
            document.getElementById('locTypeWorkspace').classList.toggle('active', type === 'workspace');
            document.getElementById('locTypePersonal').classList.toggle('active', type === 'personal');
            
            // Show/hide workspace dropdown
            document.getElementById('workspaceGroup').style.display = type === 'workspace' ? 'block' : 'none';
            
            // Reset folder dropdown
            const folderSelect = document.getElementById('newModelFolderId');
            
            if (type === 'workspace') {
                folderSelect.innerHTML = '<option value="">Select a workspace first...</option>';
                folderSelect.disabled = true;
                // Reset workspace selection
                document.getElementById('newModelWorkspaceId').value = '';
            } else {
                // Load personal folders (My Documents)
                loadPersonalFolders();
            }
        }
        
        async function loadPersonalFolders() {
            const select = document.getElementById('newModelFolderId');
            select.innerHTML = '<option value="">Loading folders...</option>';
            select.disabled = true;
            
            try {
                // Get personal files/folders (no parentId = root/My Documents level)
                const response = await fetch(`${state.baseUrl}/v2/files?typeFilters=folder`, {
                    headers: { 'Authorization': `Bearer ${state.accessToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load folders');
                
                const data = await response.json();
                wizardState.folders = data.entries || [];
                
                select.innerHTML = '';
                
                // Add "My Documents root" option
                const rootOption = document.createElement('option');
                rootOption.value = 'personal';
                rootOption.textContent = 'üìÅ My Documents (Root)';
                select.appendChild(rootOption);
                
                // Add folders
                wizardState.folders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder.id || folder.inodeId;
                    option.textContent = 'üìÅ ' + (folder.name || folder.id);
                    select.appendChild(option);
                });
                
                select.disabled = false;
                
            } catch (error) {
                console.error('Failed to load personal folders:', error);
                select.innerHTML = '<option value="">Failed to load folders</option>';
                select.disabled = true;
            }
        }
        
        async function loadWorkspaces() {
            const select = document.getElementById('newModelWorkspaceId');
            select.innerHTML = '<option value="">Loading workspaces...</option>';
            
            try {
                const response = await fetch(`${state.baseUrl}/v2/workspaces`, {
                    headers: { 'Authorization': `Bearer ${state.accessToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load workspaces');
                
                const data = await response.json();
                wizardState.workspaces = data.entries || [];
                
                select.innerHTML = '<option value="">Select a workspace...</option>';
                wizardState.workspaces.forEach(ws => {
                    const option = document.createElement('option');
                    option.value = ws.workspaceId;
                    option.textContent = ws.name || ws.workspaceId;
                    select.appendChild(option);
                });
                
                // Add change listener
                select.onchange = function() {
                    if (this.value) {
                        loadFolders(this.value);
                    } else {
                        const folderSelect = document.getElementById('newModelFolderId');
                        folderSelect.innerHTML = '<option value="">Select a workspace first...</option>';
                        folderSelect.disabled = true;
                    }
                };
                
            } catch (error) {
                console.error('Failed to load workspaces:', error);
                select.innerHTML = '<option value="">Failed to load workspaces</option>';
            }
        }
        
        async function loadFolders(workspaceId) {
            const select = document.getElementById('newModelFolderId');
            select.innerHTML = '<option value="">Loading folders...</option>';
            select.disabled = true;
            
            try {
                // Get files in the workspace, filter for folders
                const response = await fetch(`${state.baseUrl}/v2/files?typeFilters=folder&parentId=${workspaceId}`, {
                    headers: { 'Authorization': `Bearer ${state.accessToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load folders');
                
                const data = await response.json();
                wizardState.folders = data.entries || [];
                
                select.innerHTML = '';
                
                // Add workspace root as an option
                const rootOption = document.createElement('option');
                rootOption.value = workspaceId;
                rootOption.textContent = 'üìÅ (Workspace Root)';
                select.appendChild(rootOption);
                
                // Add folders
                wizardState.folders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder.id || folder.inodeId;
                    option.textContent = 'üìÅ ' + (folder.name || folder.id);
                    select.appendChild(option);
                });
                
                select.disabled = false;
                
            } catch (error) {
                console.error('Failed to load folders:', error);
                select.innerHTML = '<option value="">Failed to load folders</option>';
                select.disabled = true;
            }
        }
        
        async function loadConnections() {
            const select = document.getElementById('newModelConnectionId');
            select.innerHTML = '<option value="">Loading connections...</option>';
            
            try {
                const response = await fetch(`${state.baseUrl}/v2/connections`, {
                    headers: { 'Authorization': `Bearer ${state.accessToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load connections');
                
                const data = await response.json();
                wizardState.connections = data.entries || [];
                
                select.innerHTML = '<option value="">Select a connection...</option>';
                wizardState.connections.forEach(conn => {
                    const option = document.createElement('option');
                    option.value = conn.connectionId;
                    option.textContent = conn.name || conn.connectionId;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Failed to load connections:', error);
                select.innerHTML = '<option value="">Failed to load connections</option>';
            }
        }
        
        function newDataModel() {
            if (!state.accessToken) {
                showToast('Please connect to Sigma first', 'error');
                return;
            }
            
            // Reset wizard state
            wizardState.tables = [];
            wizardState.locationType = 'workspace';
            document.getElementById('newModelName').value = '';
            document.getElementById('tablesContainer').innerHTML = '';
            
            // Reset location type buttons
            document.getElementById('locTypeWorkspace').classList.add('active');
            document.getElementById('locTypePersonal').classList.remove('active');
            document.getElementById('workspaceGroup').style.display = 'block';
            
            // Reset workspace dropdown
            const wsSelect = document.getElementById('newModelWorkspaceId');
            wsSelect.innerHTML = '<option value="">Loading workspaces...</option>';
            
            // Reset folder dropdown
            const folderSelect = document.getElementById('newModelFolderId');
            folderSelect.innerHTML = '<option value="">Select a workspace first...</option>';
            folderSelect.disabled = true;
            
            // Reset connection dropdown
            const connSelect = document.getElementById('newModelConnectionId');
            connSelect.innerHTML = '<option value="">Loading connections...</option>';
            
            // Add one table by default
            addTableConfig();
            
            // Show modal
            document.getElementById('newModelModal').classList.add('active');
            
            // Load workspaces and connections
            loadWorkspaces();
            loadConnections();
        }
        
        function closeNewModelModal() {
            document.getElementById('newModelModal').classList.remove('active');
        }
        
        let tableCounter = 0;
        
        function addTableConfig() {
            tableCounter++;
            const tableId = `table_${tableCounter}`;
            const container = document.getElementById('tablesContainer');
            
            const tableHtml = `
                <div class="table-config" id="${tableId}">
                    <div class="table-config-header">
                        <span class="table-config-title">Table ${tableCounter}</span>
                        <button class="table-config-remove" onclick="removeTableConfig('${tableId}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Table Name *</label>
                        <input type="text" class="form-input table-name" placeholder="e.g., Orders">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Source Path * (Database / Schema / Table)</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                            <input type="text" class="form-input table-database" placeholder="DATABASE">
                            <input type="text" class="form-input table-schema" placeholder="SCHEMA">
                            <input type="text" class="form-input table-source" placeholder="TABLE_NAME">
                        </div>
                        <div class="form-hint">The warehouse path to your source table</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Columns</label>
                        <div class="column-list" id="${tableId}_columns"></div>
                        <div class="add-column-row">
                            <input type="text" class="form-input" id="${tableId}_newColumn" placeholder="Column name" onkeypress="if(event.key==='Enter'){addColumn('${tableId}'); event.preventDefault();}">
                            <button class="btn btn-secondary btn-small" onclick="addColumn('${tableId}')">Add</button>
                        </div>
                        <div class="form-hint">Press Enter or click Add for each column. Leave empty to add columns later in Sigma.</div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', tableHtml);
        }
        
        function removeTableConfig(tableId) {
            const element = document.getElementById(tableId);
            if (element) {
                element.remove();
            }
        }
        
        function addColumn(tableId) {
            const input = document.getElementById(`${tableId}_newColumn`);
            const columnName = input.value.trim();
            
            if (!columnName) return;
            
            const columnList = document.getElementById(`${tableId}_columns`);
            const columnId = `${tableId}_col_${Date.now()}`;
            
            const columnHtml = `
                <span class="column-tag" id="${columnId}" data-column-name="${columnName}">
                    ${columnName}
                    <button class="column-tag-remove" onclick="removeColumn('${columnId}')">&times;</button>
                </span>
            `;
            
            columnList.insertAdjacentHTML('beforeend', columnHtml);
            input.value = '';
            input.focus();
        }
        
        function removeColumn(columnId) {
            const element = document.getElementById(columnId);
            if (element) {
                element.remove();
            }
        }
        
        async function createDataModelFromWizard() {
            const modelName = document.getElementById('newModelName').value.trim();
            const workspaceId = document.getElementById('newModelWorkspaceId').value;
            const folderId = document.getElementById('newModelFolderId').value;
            const connectionId = document.getElementById('newModelConnectionId').value;
            
            if (!modelName) {
                showToast('Please enter a data model name', 'error');
                return;
            }
            
            // Only require workspace if workspace location type is selected
            if (wizardState.locationType === 'workspace' && !workspaceId) {
                showToast('Please select a workspace', 'error');
                return;
            }
            
            if (!folderId) {
                showToast('Please select a folder', 'error');
                return;
            }
            
            if (!connectionId) {
                showToast('Please select a connection', 'error');
                return;
            }
            
            // Determine actual folder ID (for personal root, we may need to handle differently)
            const actualFolderId = folderId === 'personal' ? null : folderId;
            const tableConfigs = document.querySelectorAll('.table-config');
            const elements = [];
            
            tableConfigs.forEach((tableEl, index) => {
                const tableName = tableEl.querySelector('.table-name').value.trim();
                const database = tableEl.querySelector('.table-database').value.trim();
                const schema = tableEl.querySelector('.table-schema').value.trim();
                const sourceTable = tableEl.querySelector('.table-source').value.trim();
                
                if (!tableName || !database || !schema || !sourceTable) {
                    return; // Skip incomplete tables
                }
                
                // Get columns
                const columnTags = tableEl.querySelectorAll('.column-tag');
                const columns = [];
                
                columnTags.forEach((tag, colIndex) => {
                    const colName = tag.getAttribute('data-column-name');
                    if (colName) {
                        columns.push({
                            id: `col_${index}_${colIndex}_${Date.now()}`,
                            name: colName,
                            formula: `[${sourceTable}/${colName}]`
                        });
                    }
                });
                
                elements.push({
                    id: `element_${index}_${Date.now()}`,
                    name: tableName,
                    kind: "table",
                    source: {
                        connectionId: connectionId,
                        kind: "warehouse-table",
                        path: [database, schema, sourceTable]
                    },
                    columns: columns
                });
            });
            
            if (elements.length === 0) {
                showToast('Please configure at least one table with all required fields', 'error');
                return;
            }
            
            // Create the data model spec
            const spec = {
                schemaVersion: 1,
                name: modelName,
                pages: [
                    {
                        id: "page_" + Date.now(),
                        name: "Page 1",
                        elements: elements
                    }
                ]
            };
            
            // Add folderId if a specific folder is selected (not personal root)
            if (actualFolderId) {
                spec.folderId = actualFolderId;
            }
            
            // Set up state for the new model (don't save yet - let user review)
            state.selectedModel = spec;
            state.isNewModel = true;
            state.originalJson = null;
            
            // Update UI - show JSON for review
            document.getElementById('editorTitle').textContent = modelName + ' (New - Unsaved)';
            document.getElementById('jsonEditor').value = JSON.stringify(spec, null, 2);
            
            // Enable buttons
            document.getElementById('formatBtn').disabled = false;
            document.getElementById('copyBtn').disabled = false;
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('refreshSigmaBtn').disabled = true; // Can't refresh unsaved model
            document.getElementById('aiBtn').disabled = false;
            
            // Close modal
            closeNewModelModal();
            
            updateStatus('connected', `New: ${modelName} (unsaved)`);
            showToast(`Data model created with ${elements.length} table(s). Review the JSON and click "Save to Sigma" when ready.`, 'success');
        }
        
        // ============================================
        // AI ASSISTANT
        // ============================================
        
        const AI_STORAGE_KEY = 'sigma-dm-ai-config';
        
        // Data Model Schema Documentation for AI
        const DATA_MODEL_SCHEMA = `
## Sigma Data Model JSON Schema

A data model has this structure:
{
  "schemaVersion": 1,
  "name": "Model Name",
  "description": "Optional description",
  "pages": [
    {
      "id": "page_<timestamp>",
      "name": "Page 1",
      "elements": [...]
    }
  ]
}

### Element Types

**Table Element:**
{
  "id": "element_<timestamp>",
  "type": "table",
  "name": "Table Display Name",
  "connectionId": "<connection-uuid>",
  "path": ["DATABASE", "SCHEMA", "TABLE_NAME"],
  "columns": [
    {
      "id": "col_<timestamp>",
      "name": "Column Display Name",
      "sourceName": "ORIGINAL_COLUMN_NAME",
      "type": "text|number|datetime|boolean"
    }
  ]
}

**Calculated Column (add to columns array):**
{
  "id": "calc_<timestamp>",
  "name": "Calculated Column Name",
  "formula": "[Price] - [Cost]",
  "type": "number"
}

**Metric:**
{
  "id": "metric_<timestamp>",
  "name": "Metric Name",
  "description": "What this metric measures",
  "formula": "Sum([Amount])",
  "formatOptions": {
    "type": "currency|percent|number"
  }
}

**Relationship (add to element):**
{
  "relationships": [
    {
      "targetElementId": "<element_id_of_related_table>",
      "sourceColumns": ["col_id_in_this_table"],
      "targetColumns": ["col_id_in_target_table"],
      "type": "many_to_one"
    }
  ]
}

### Formula Syntax
- Reference columns by their friendly name: [Column Name]
- Do NOT include table name in formulas - just use [Column Name]
- Aggregations: Sum(), Count(), Avg(), Min(), Max(), CountDistinct()
- Math: +, -, *, /, ()
- Conditional: If([condition], true_value, false_value)
- Text: Concat(), Left(), Right(), Contains()
- Date: DateTrunc(), DateDiff(), Today()

### Formula Examples
- Sum of a column: Sum([Amount])
- Count distinct: CountDistinct([Customer Key])
- Calculation: [Price] - [Cost]
- Percentage: [Profit] / [Revenue]
`;

        function loadAIConfig() {
            try {
                const saved = localStorage.getItem(AI_STORAGE_KEY);
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.error('Failed to load AI config:', e);
            }
            return { provider: 'openai', keys: {} };
        }
        
        function saveAIConfig(config) {
            try {
                localStorage.setItem(AI_STORAGE_KEY, JSON.stringify(config));
            } catch (e) {
                console.error('Failed to save AI config:', e);
            }
        }
        
        let aiCurrentMode = 'enhance';
        
        async function openAIAssistant() {
            const config = loadAIConfig();
            document.getElementById('aiProvider').value = config.provider || 'openai';
            onAIProviderChange(); // Load the saved key for this provider
            document.getElementById('aiResults').style.display = 'none';
            document.getElementById('aiLoading').style.display = 'none';
            
            // Reset input fields
            document.getElementById('aiPromptEnhance').value = '';
            document.getElementById('aiPromptAddTable').value = '';
            document.getElementById('aiDatabase').value = '';
            document.getElementById('aiSchema').value = '';
            document.getElementById('aiTable').value = '';
            document.getElementById('aiColumns').value = '';
            
            // Set to enhance mode by default
            setAIMode('enhance');
            
            // Load connections for the dropdown
            await loadAIConnections();
            
            document.getElementById('aiModal').classList.add('active');
        }
        
        function setAIMode(mode) {
            aiCurrentMode = mode;
            
            // Update tab buttons
            document.querySelectorAll('.ai-mode-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.mode === mode);
            });
            
            // Show/hide content
            document.getElementById('aiModeEnhance').style.display = mode === 'enhance' ? 'block' : 'none';
            document.getElementById('aiModeAddTable').style.display = mode === 'addtable' ? 'block' : 'none';
        }
        
        async function loadAIConnections() {
            const select = document.getElementById('aiConnection');
            select.innerHTML = '<option value="">Loading connections...</option>';
            
            try {
                const response = await fetch(`${state.baseUrl}/v2/connections`, {
                    headers: { 'Authorization': `Bearer ${state.accessToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load connections');
                
                const data = await response.json();
                const connections = data.entries || [];
                
                select.innerHTML = '<option value="">Select a connection...</option>';
                connections.forEach(conn => {
                    const option = document.createElement('option');
                    option.value = conn.connectionId;
                    option.textContent = conn.name || conn.connectionId;
                    select.appendChild(option);
                });
                
                // Try to auto-select based on current model
                const currentJson = document.getElementById('jsonEditor').value;
                try {
                    const currentModel = JSON.parse(currentJson);
                    const elements = currentModel.pages?.[0]?.elements || [];
                    const connectionId = elements.find(e => e.connectionId)?.connectionId;
                    if (connectionId) {
                        select.value = connectionId;
                    }
                } catch (e) {
                    // Ignore parse errors
                }
                
            } catch (error) {
                console.error('Failed to load connections:', error);
                select.innerHTML = '<option value="">Failed to load connections</option>';
            }
        }
        
        function closeAIModal() {
            document.getElementById('aiModal').classList.remove('active');
        }
        
        function onAIProviderChange() {
            const provider = document.getElementById('aiProvider').value;
            const config = loadAIConfig();
            // Load saved key for this provider if exists
            const savedKeys = config.keys || {};
            document.getElementById('aiApiKey').value = savedKeys[provider] || '';
        }
        
        function saveAIKey() {
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('aiApiKey').value;
            
            const config = loadAIConfig();
            if (!config.keys) config.keys = {};
            config.keys[provider] = apiKey;
            config.provider = provider;
            
            saveAIConfig(config);
            showToast('API key saved', 'success');
        }
        
        async function generateAISuggestion() {
            const config = loadAIConfig();
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('aiApiKey').value || config.keys?.[provider];
            
            if (!apiKey) {
                showToast('Please enter an API key', 'error');
                return;
            }
            
            // Get current model JSON
            const currentJson = document.getElementById('jsonEditor').value;
            let currentModel = null;
            try {
                currentModel = JSON.parse(currentJson);
            } catch (e) {
                // Editor might be empty or invalid
            }
            
            let userPrompt = '';
            let contextInfo = '';
            
            if (aiCurrentMode === 'enhance') {
                userPrompt = document.getElementById('aiPromptEnhance').value.trim();
                
                if (!userPrompt) {
                    showToast('Please describe what you want to add or change', 'error');
                    return;
                }
                
                if (!currentModel) {
                    showToast('No data model loaded. Create or load a model first.', 'error');
                    return;
                }
                
                // Extract table and column info
                const elements = currentModel.pages?.[0]?.elements || [];
                const existingTables = elements.filter(e => e.type === 'table').map(t => ({
                    name: t.name,
                    id: t.id,
                    columns: (t.columns || []).map(c => ({ name: c.name, sourceName: c.sourceName, type: c.type, id: c.id }))
                }));
                
                contextInfo = `
## Existing Tables and Columns in This Model
${JSON.stringify(existingTables, null, 2)}

IMPORTANT: When referencing columns in formulas, use just [Column Name] - do NOT include the table name. Use the "name" field (friendly name), not sourceName.
When adding calculated columns, add them to the columns array of the appropriate table using its ID from above.`;
                
            } else if (aiCurrentMode === 'addtable') {
                const connectionId = document.getElementById('aiConnection').value;
                const connectionName = document.getElementById('aiConnection').selectedOptions[0]?.textContent || '';
                const database = document.getElementById('aiDatabase').value.trim();
                const schema = document.getElementById('aiSchema').value.trim();
                const table = document.getElementById('aiTable').value.trim();
                const columnsText = document.getElementById('aiColumns').value.trim();
                const additionalInstructions = document.getElementById('aiPromptAddTable').value.trim();
                
                if (!connectionId) {
                    showToast('Please select a connection', 'error');
                    return;
                }
                
                if (!database || !schema || !table) {
                    showToast('Please enter the database, schema, and table name', 'error');
                    return;
                }
                
                // Parse columns from user input
                let parsedColumns = [];
                if (columnsText) {
                    const lines = columnsText.split('\n').filter(l => l.trim());
                    parsedColumns = lines.map(line => {
                        // Try to parse "COLUMN_NAME (type)" format
                        const match = line.match(/^\s*([A-Za-z_][A-Za-z0-9_]*)\s*(?:\((\w+)\))?/);
                        if (match) {
                            return {
                                sourceName: match[1].toUpperCase(),
                                type: match[2]?.toLowerCase() || 'text'
                            };
                        }
                        return null;
                    }).filter(Boolean);
                }
                
                userPrompt = `Create a table element for the ${table} table.${additionalInstructions ? ' ' + additionalInstructions : ''}`;
                
                contextInfo = `
## Connection Details
- Connection ID: ${connectionId}
- Connection Name: ${connectionName}
IMPORTANT: Use this exact connectionId: "${connectionId}"

## Table Path
- Database: ${database}
- Schema: ${schema}  
- Table: ${table}
- Path array: ["${database}", "${schema}", "${table}"]

## Column Definitions (USE THESE EXACT COLUMNS)
${parsedColumns.length > 0 ? parsedColumns.map(c => `- ${c.sourceName} (${c.type})`).join('\n') : 'No columns provided - create reasonable columns based on the table name, or ask user to provide them.'}

${parsedColumns.length > 0 ? 'CRITICAL: Only use the columns listed above. Do NOT invent additional columns.' : ''}`;
            }
            
            // Show loading
            document.getElementById('aiResults').style.display = 'none';
            document.getElementById('aiLoading').style.display = 'block';
            document.getElementById('aiGenerateBtn').disabled = true;
            
            try {
                const systemPrompt = `You are a Sigma Computing data model expert. You help users build and modify data models using JSON.

${DATA_MODEL_SCHEMA}

## Current Data Model
${currentModel ? JSON.stringify(currentModel, null, 2) : 'No model loaded yet - creating new elements.'}
${contextInfo}

## Instructions
1. Based on the user's request, generate the JSON snippet that should be added or modified
2. Use proper Sigma formula syntax: reference columns as [Column Name] - do NOT include table name in formulas
3. Generate unique IDs using pattern: type_name_${Date.now()}
4. Return your response in this exact format:

JSON:
\`\`\`json
{
  // your suggested JSON here
}
\`\`\`

EXPLANATION:
Explain what the JSON does and how to use it.

IMPORTANT: The JSON should be a snippet that can be merged into the model, not the entire model.`;

                let response;
                
                if (provider === 'openai') {
                    response = await callOpenAI(apiKey, systemPrompt, userPrompt);
                } else if (provider === 'anthropic') {
                    response = await callAnthropic(apiKey, systemPrompt, userPrompt);
                } else if (provider === 'gemini') {
                    response = await callGemini(apiKey, systemPrompt, userPrompt);
                }
                
                // Parse response
                const jsonMatch = response.match(/```json\n?([\s\S]*?)\n?```/);
                const explanationMatch = response.match(/EXPLANATION:\s*([\s\S]*?)(?:$|```)/i);
                
                const jsonSuggestion = jsonMatch ? jsonMatch[1].trim() : response;
                const explanation = explanationMatch ? explanationMatch[1].trim() : 'Generated based on your request.';
                
                document.getElementById('aiSuggestion').value = jsonSuggestion;
                document.getElementById('aiExplanation').textContent = explanation;
                document.getElementById('aiResults').style.display = 'block';
                
                // Generate insertion preview
                try {
                    generateInsertionPreview(jsonSuggestion);
                } catch (e) {
                    console.warn('Could not generate preview:', e);
                    document.getElementById('aiPreview').style.display = 'none';
                }
                
            } catch (error) {
                console.error('AI Error:', error);
                showToast(`AI Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('aiLoading').style.display = 'none';
                document.getElementById('aiGenerateBtn').disabled = false;
            }
        }
        
        async function callOpenAI(apiKey, systemPrompt, userMessage) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userMessage }
                    ],
                    max_tokens: 2000,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'OpenAI API error');
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        async function callAnthropic(apiKey, systemPrompt, userMessage) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 2000,
                    messages: [
                        { role: 'user', content: systemPrompt + '\n\nUser Request: ' + userMessage }
                    ]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Anthropic API error');
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        async function callGemini(apiKey, systemPrompt, userMessage) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [
                        {
                            role: 'user',
                            parts: [{ text: systemPrompt + '\n\nUser Request: ' + userMessage }]
                        }
                    ],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 2000
                    }
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Gemini API error');
            }
            
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }
        
        function copyAISuggestion() {
            const suggestion = document.getElementById('aiSuggestion').value;
            navigator.clipboard.writeText(suggestion);
            showToast('Copied! Paste into the appropriate location in your JSON editor.', 'success');
        }
        
        // Smart Insert AI Suggestion
        async function smartInsertAISuggestion() {
            const editor = document.getElementById('jsonEditor');
            const suggestion = document.getElementById('aiSuggestion').value;
            
            try {
                // Parse the suggestion to understand what it is
                let suggestionObj;
                try {
                    suggestionObj = JSON.parse(suggestion);
                } catch (e) {
                    showToast('‚ùå AI suggestion is not valid JSON. Check for syntax errors.', 'error');
                    return;
                }
                
                // Parse the current editor content
                let currentJson;
                try {
                    currentJson = JSON.parse(editor.value);
                } catch (e) {
                    showToast('‚ùå Current JSON is invalid. Please fix errors first:\n' + e.message, 'error');
                    return;
                }
                
                // Validate data model structure
                if (!currentJson.pages || !Array.isArray(currentJson.pages)) {
                    showToast('‚ùå Data model must have a "pages" array.', 'error');
                    return;
                }
                
                // Detect what type of suggestion this is
                const suggestionType = detectSuggestionType(suggestionObj);
                
                if (suggestionType === 'unknown') {
                    showToast('‚ùå Could not determine suggestion type. The JSON structure may not match expected patterns.', 'error');
                    return;
                }
                
                // Find the best place to insert it
                const insertionResult = findInsertionPoint(currentJson, suggestionType, suggestionObj);
                
                if (!insertionResult.success) {
                    showToast(`‚ùå ${insertionResult.error}`, 'error');
                    return;
                }
                
                // Insert the suggestion
                const updatedJson = insertSuggestion(currentJson, insertionResult.path, suggestionObj, suggestionType);
                
                // Validate the result is still valid JSON
                try {
                    JSON.stringify(updatedJson);
                } catch (e) {
                    showToast('‚ùå Insertion would create invalid JSON. Please check the suggestion.', 'error');
                    return;
                }
                
                // Update the editor
                editor.value = JSON.stringify(updatedJson, null, 2);
                
                // Close modal and show success
                closeAIModal();
                
                const name = suggestionObj.name || suggestionObj.id || 'item';
                showToast(`‚úÖ Inserted "${name}" at: ${insertionResult.description}`, 'success');
                
                // Auto-format
                setTimeout(() => formatJson(), 100);
                
            } catch (e) {
                console.error('Smart insert error:', e);
                showToast(`‚ùå Failed to insert: ${e.message}. Try copying and pasting manually.`, 'error');
            }
        }
        
        // Detect what type of JSON suggestion this is
        function detectSuggestionType(obj) {
            // Check for column
            if (obj.id && obj.formula && (obj.name || obj.description)) {
                return 'column';
            }
            
            // Check for metric
            if (obj.id && obj.formula && obj.name && !obj.description) {
                return 'metric';
            }
            
            // Check for relationship
            if (obj.id && obj.targetElementId && obj.keys) {
                return 'relationship';
            }
            
            // Check for filter
            if (obj.id && obj.columnId && obj.kind) {
                return 'filter';
            }
            
            // Check for element (table)
            if (obj.id && obj.name && obj.kind === 'table' && obj.source) {
                return 'element';
            }
            
            // Check for page
            if (obj.id && obj.name && obj.elements) {
                return 'page';
            }
            
            return 'unknown';
        }
        
        // Find where to insert the suggestion
        function findInsertionPoint(json, suggestionType, suggestionObj) {
            switch (suggestionType) {
                case 'column':
                    // Find the first table element with columns array
                    for (let pageIdx = 0; pageIdx < json.pages.length; pageIdx++) {
                        const page = json.pages[pageIdx];
                        for (let elemIdx = 0; elemIdx < (page.elements || []).length; elemIdx++) {
                            const element = page.elements[elemIdx];
                            if (element.kind === 'table' && Array.isArray(element.columns)) {
                                return {
                                    success: true,
                                    path: ['pages', pageIdx, 'elements', elemIdx, 'columns'],
                                    description: `Page "${page.name}" ‚Üí Table "${element.name}" ‚Üí Columns`
                                };
                            }
                        }
                    }
                    return {
                        success: false,
                        error: 'No table with columns array found. Create a table element first.'
                    };
                    
                case 'metric':
                    // Find the first table element with metrics array (or create it)
                    for (let pageIdx = 0; pageIdx < json.pages.length; pageIdx++) {
                        const page = json.pages[pageIdx];
                        for (let elemIdx = 0; elemIdx < (page.elements || []).length; elemIdx++) {
                            const element = page.elements[elemIdx];
                            if (element.kind === 'table') {
                                return {
                                    success: true,
                                    path: ['pages', pageIdx, 'elements', elemIdx, 'metrics'],
                                    description: `Page "${page.name}" ‚Üí Table "${element.name}" ‚Üí Metrics`
                                };
                            }
                        }
                    }
                    return {
                        success: false,
                        error: 'No table element found. Create a table element first.'
                    };
                    
                case 'relationship':
                    // Find the first table element with relationships array (or create it)
                    for (let pageIdx = 0; pageIdx < json.pages.length; pageIdx++) {
                        const page = json.pages[pageIdx];
                        for (let elemIdx = 0; elemIdx < (page.elements || []).length; elemIdx++) {
                            const element = page.elements[elemIdx];
                            if (element.kind === 'table') {
                                return {
                                    success: true,
                                    path: ['pages', pageIdx, 'elements', elemIdx, 'relationships'],
                                    description: `Page "${page.name}" ‚Üí Table "${element.name}" ‚Üí Relationships`
                                };
                            }
                        }
                    }
                    return {
                        success: false,
                        error: 'No table element found. Create a table element first.'
                    };
                    
                case 'filter':
                    // Find the first table element with filters array (or create it)
                    for (let pageIdx = 0; pageIdx < json.pages.length; pageIdx++) {
                        const page = json.pages[pageIdx];
                        for (let elemIdx = 0; elemIdx < (page.elements || []).length; elemIdx++) {
                            const element = page.elements[elemIdx];
                            if (element.kind === 'table') {
                                return {
                                    success: true,
                                    path: ['pages', pageIdx, 'elements', elemIdx, 'filters'],
                                    description: `Page "${page.name}" ‚Üí Table "${element.name}" ‚Üí Filters`
                                };
                            }
                        }
                    }
                    return {
                        success: false,
                        error: 'No table element found. Create a table element first.'
                    };
                    
                case 'element':
                    // Add to the first page's elements array
                    if (json.pages && json.pages.length > 0) {
                        return {
                            success: true,
                            path: ['pages', 0, 'elements'],
                            description: `Page "${json.pages[0].name}" ‚Üí Elements`
                        };
                    }
                    return {
                        success: false,
                        error: 'No pages found in data model.'
                    };
                    
                case 'page':
                    // Add to the pages array
                    return {
                        success: true,
                        path: ['pages'],
                        description: 'Root ‚Üí Pages'
                    };
                    
                default:
                    return {
                        success: false,
                        error: 'Could not determine suggestion type. Try copying and pasting manually.'
                    };
            }
        }
        
        // Insert the suggestion at the specified path
        function insertSuggestion(json, path, suggestion, suggestionType) {
            // Deep clone the JSON
            const newJson = JSON.parse(JSON.stringify(json));
            
            // Navigate to the insertion point
            let target = newJson;
            for (let i = 0; i < path.length - 1; i++) {
                target = target[path[i]];
            }
            
            const lastKey = path[path.length - 1];
            
            // Ensure the array exists
            if (!Array.isArray(target[lastKey])) {
                target[lastKey] = [];
            }
            
            // Check for duplicate IDs before inserting
            const existingIds = target[lastKey].map(item => item.id);
            if (existingIds.includes(suggestion.id)) {
                // Generate a new unique ID
                let counter = 1;
                let newId = `${suggestion.id}_${counter}`;
                while (existingIds.includes(newId)) {
                    counter++;
                    newId = `${suggestion.id}_${counter}`;
                }
                suggestion.id = newId;
                console.log(`Duplicate ID detected, changed to: ${newId}`);
            }
            
            // Add the suggestion to the array
            target[lastKey].push(suggestion);
            
            return newJson;
        }
        
        // Generate a preview of where the suggestion will be inserted
        function generateInsertionPreview(suggestionText) {
            const editor = document.getElementById('jsonEditor');
            const previewDiv = document.getElementById('aiPreview');
            const typeDiv = document.getElementById('aiPreviewType');
            const locationDiv = document.getElementById('aiPreviewLocation');
            const detailsDiv = document.getElementById('aiPreviewDetails');
            
            try {
                // Parse suggestion and current JSON
                const suggestion = JSON.parse(suggestionText);
                const currentJson = JSON.parse(editor.value);
                
                // Detect type
                const suggestionType = detectSuggestionType(suggestion);
                
                // Find insertion point
                const insertionResult = findInsertionPoint(currentJson, suggestionType, suggestion);
                
                if (insertionResult.success) {
                    // Show preview
                    const typeLabels = {
                        'column': 'üìä Column',
                        'metric': 'üìà Metric',
                        'relationship': 'üîó Relationship',
                        'filter': 'üîç Filter',
                        'element': 'üì¶ Table Element',
                        'page': 'üìÑ Page'
                    };
                    
                    typeDiv.textContent = typeLabels[suggestionType] || suggestionType;
                    locationDiv.textContent = `Will be inserted at: ${insertionResult.description}`;
                    
                    // Show what will be added
                    const name = suggestion.name || suggestion.id || 'Unnamed';
                    detailsDiv.textContent = `Adding "${name}" with ID: ${suggestion.id}`;
                    
                    previewDiv.style.display = 'block';
                } else {
                    // Show error in preview
                    typeDiv.textContent = '‚ö†Ô∏è Cannot Auto-Insert';
                    locationDiv.textContent = insertionResult.error;
                    detailsDiv.textContent = 'Use "Copy" and paste manually.';
                    previewDiv.style.display = 'block';
                }
            } catch (e) {
                // Hide preview if there's an error
                previewDiv.style.display = 'none';
            }
        }
        
        // Validate AI Suggestion
        function validateAISuggestion() {
            const editor = document.getElementById('jsonEditor');
            const suggestion = document.getElementById('aiSuggestion').value;
            
            let errors = [];
            let warnings = [];
            let info = [];
            
            // Check 1: Is the suggestion valid JSON?
            let suggestionObj;
            try {
                suggestionObj = JSON.parse(suggestion);
                info.push('‚úì Valid JSON syntax');
            } catch (e) {
                errors.push('‚úó Invalid JSON syntax: ' + e.message);
                showValidationResults(errors, warnings, info);
                return;
            }
            
            // Check 2: Can we detect the type?
            const suggestionType = detectSuggestionType(suggestionObj);
            if (suggestionType === 'unknown') {
                warnings.push('‚ö† Cannot auto-detect suggestion type');
                info.push('This may require manual placement');
            } else {
                info.push(`‚úì Detected as: ${suggestionType}`);
            }
            
            // Check 3: Is the current JSON valid?
            let currentJson;
            try {
                currentJson = JSON.parse(editor.value);
                info.push('‚úì Current data model is valid JSON');
            } catch (e) {
                errors.push('‚úó Current data model has JSON errors: ' + e.message);
                showValidationResults(errors, warnings, info);
                return;
            }
            
            // Check 4: Can we find an insertion point?
            if (suggestionType !== 'unknown') {
                const insertionResult = findInsertionPoint(currentJson, suggestionType, suggestionObj);
                if (insertionResult.success) {
                    info.push(`‚úì Will insert at: ${insertionResult.description}`);
                } else {
                    warnings.push(`‚ö† ${insertionResult.error}`);
                }
            }
            
            // Check 5: Does the ID already exist?
            if (suggestionObj.id && currentJson.pages) {
                const allIds = [];
                currentJson.pages.forEach(page => {
                    if (page.id) allIds.push(page.id);
                    (page.elements || []).forEach(elem => {
                        if (elem.id) allIds.push(elem.id);
                        ['columns', 'metrics', 'relationships', 'filters'].forEach(arrayName => {
                            (elem[arrayName] || []).forEach(item => {
                                if (item.id) allIds.push(item.id);
                            });
                        });
                    });
                });
                
                if (allIds.includes(suggestionObj.id)) {
                    warnings.push(`‚ö† ID "${suggestionObj.id}" already exists - will auto-rename on insert`);
                } else {
                    info.push(`‚úì ID "${suggestionObj.id}" is unique`);
                }
            }
            
            // Check 6: Required fields check
            const requiredFields = {
                'column': ['id', 'formula'],
                'metric': ['id', 'formula'],
                'relationship': ['id', 'targetElementId', 'keys'],
                'filter': ['id', 'columnId', 'kind'],
                'element': ['id', 'name', 'kind', 'source'],
                'page': ['id', 'name', 'elements']
            };
            
            if (suggestionType !== 'unknown' && requiredFields[suggestionType]) {
                const missing = requiredFields[suggestionType].filter(field => !suggestionObj[field]);
                if (missing.length > 0) {
                    errors.push(`‚úó Missing required fields: ${missing.join(', ')}`);
                } else {
                    info.push(`‚úì All required fields present`);
                }
            }
            
            showValidationResults(errors, warnings, info);
        }
        
        // Show validation results
        function showValidationResults(errors, warnings, info) {
            let message = '';
            
            if (errors.length > 0) {
                message += '‚ùå ERRORS:\n' + errors.join('\n') + '\n\n';
            }
            
            if (warnings.length > 0) {
                message += '‚ö†Ô∏è WARNINGS:\n' + warnings.join('\n') + '\n\n';
            }
            
            if (info.length > 0) {
                message += '‚úì INFO:\n' + info.join('\n');
            }
            
            if (errors.length === 0 && warnings.length === 0) {
                showToast('‚úÖ Validation passed! Ready to insert.', 'success');
            } else if (errors.length > 0) {
                alert(message);
            } else {
                alert(message + '\n\n‚ö†Ô∏è You can proceed but review the warnings above.');
            }
        }
        
        // Auto-resize textarea
        const editor = document.getElementById('jsonEditor');
        editor.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.max(this.scrollHeight, 500) + 'px';
        });
        
        // Load saved credentials on page load
        function loadSavedCredentials() {
            const saved = localStorage.getItem('sigma_standalone_credentials');
            if (saved) {
                try {
                    const creds = JSON.parse(saved);
                    document.getElementById('clientId').value = creds.clientId || '';
                    document.getElementById('clientSecret').value = creds.clientSecret || '';
                    if (creds.apiUrl) {
                        document.getElementById('apiRegion').value = creds.apiUrl;
                        state.baseUrl = creds.apiUrl;
                    }
                } catch (e) {
                    console.error('Failed to load saved credentials:', e);
                }
            }
        }
        
        // Clear saved credentials
        function clearCredentials() {
            localStorage.removeItem('sigma_standalone_credentials');
            document.getElementById('clientId').value = '';
            document.getElementById('clientSecret').value = '';
            showToast('Saved credentials cleared', 'success');
        }
        
        // Developer mode (for staging environments)
        const DEV_MODE_KEY = 'sigma_standalone_dev_mode';
        let devModeClickCount = 0;
        let devModeClickTimeout = null;
        
        function checkDevMode() {
            const devMode = localStorage.getItem(DEV_MODE_KEY) === 'true';
            if (devMode) {
                enableDevMode();
            }
        }
        
        function enableDevMode() {
            document.getElementById('stagingOptgroup').style.display = '';
            document.querySelectorAll('.staging-option').forEach(opt => opt.style.display = '');
            document.getElementById('devModeBadge').style.display = 'inline-flex';
            localStorage.setItem(DEV_MODE_KEY, 'true');
            showToast('Developer mode enabled - staging environments available', 'success');
        }
        
        function disableDevMode() {
            document.getElementById('stagingOptgroup').style.display = 'none';
            document.querySelectorAll('.staging-option').forEach(opt => opt.style.display = 'none');
            document.getElementById('devModeBadge').style.display = 'none';
            localStorage.setItem(DEV_MODE_KEY, 'false');
            showToast('Developer mode disabled', 'success');
        }
        
        // Set up logo click handler for dev mode
        function setupDevMode() {
            const logoIcon = document.getElementById('logoIcon');
            
            // Check if dev mode is already enabled
            checkDevMode();
            
            logoIcon.addEventListener('click', () => {
                clearTimeout(devModeClickTimeout);
                devModeClickCount++;
                
                // Reset count after 2 seconds of no clicks
                devModeClickTimeout = setTimeout(() => {
                    devModeClickCount = 0;
                }, 2000);
                
                // Show click progress
                if (devModeClickCount >= 1 && devModeClickCount < 5) {
                    logoIcon.style.transform = 'scale(1.1)';
                    setTimeout(() => logoIcon.style.transform = '', 100);
                }
                
                // Enable dev mode after 5 clicks
                if (devModeClickCount === 5) {
                    const isDevMode = localStorage.getItem(DEV_MODE_KEY) === 'true';
                    if (isDevMode) {
                        disableDevMode();
                    } else {
                        enableDevMode();
                    }
                    devModeClickCount = 0;
                }
            });
        }
        
        // Initialize on page load
        loadSavedCredentials();
        setupDevMode();
    </script>
</body>
</html>
